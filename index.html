<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to Exam Paper Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e6e6e6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: #0f3460;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #533483, #0f3460);
            color: white;
            padding: 25px 30px;
            text-align: center;
            border-bottom: 1px solid #1a1a2e;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #1a1a2e;
        }
        
        .upload-area {
            border: 3px dashed #e94560;
            border-radius: 10px;
            padding: 40px 20px;
            margin: 20px 0;
            background-color: #1a1a2e;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #16213e;
            border-color: #f39c12;
        }
        
        .upload-area i {
            font-size: 48px;
            color: #e94560;
            margin-bottom: 15px;
        }
        
        .upload-area h3 {
            color: #f39c12;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            color: #b0b0b0;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            display: inline-block;
            background: linear-gradient(to right, #e94560, #f39c12);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-preview {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
        }
        
        .btn-download {
            background: linear-gradient(to right, #3498db, #2ecc71);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            background: #555;
            color: #999;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
        }
        
        .btn-preview:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
        }
        
        .btn-download:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .preview-section {
            padding: 30px;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e94560;
        }
        
        .preview-title {
            color: #f39c12;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .preview-container {
            background-color: #1a1a2e;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
            overflow: auto;
        }
        
        .page {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 210mm;
            /* A4 width */
            margin-left: auto;
            margin-right: auto;
            min-height: 297mm;
            /* A4 height for preview, content can overflow */
            box-sizing: border-box;
            color: black;
            position: relative;
        }
        
        .page-content-wrapper {
             padding-bottom: 30px; /* Space for page number */
        }
        
        .university-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000;
        }
        
        .university-header h2 {
            color: #000;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .university-header p {
            color: #000;
            margin: 3px 0;
            font-size: 14px;
        }
        
        .student-info {
            margin-bottom: 20px;
        }
        
        .student-info table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        
        .student-info td {
            padding: 8px 12px;
            border: 1px solid #000;
            font-size: 14px;
        }
        
        .student-info td:first-child {
            font-weight: 600;
            background-color: #f0f0f0;
            width: 30%;
        }
        
        .section-title {
            font-weight: bold;
            margin: 15px 0 8px 0;
            font-size: 16px;
            text-decoration: underline;
            color: #000;
        }
        
        .question {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .question-number {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .options {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .option {
            margin-bottom: 4px;
            padding-left: 8px;
            font-size: 13px;
        }
        
        .page-number {
            position: absolute;
            bottom: 15px;
            right: 25px;
            font-style: italic;
            color: #666;
            font-size: 12px;
        }
        
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            color: #f39c12;
        }
        
        .file-name {
            margin-top: 10px;
            font-weight: 600;
            color: #3498db;
        }
        
        .success-message {
            color: #2ecc71;
            margin-top: 10px;
            font-weight: 600;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-weight: 600;
        }
        
        .answer-space {
            min-height: 100px;
            margin: 8px 0 15px 0;
        }
        
        .long-answer-space {
            min-height: 200px;
            margin: 8px 0 15px 0;
        }
        
        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            .btn {
                width: 100%;
                max-width: 300px;
            }
            .preview-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            .page {
                width: 100%;
                min-height: 0;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CSV to Exam Paper Converter</h1>
            <p>Upload your CSV file and generate professional exam papers in PDF format</p>
        </header>
        
        <div class="upload-section">
            <div class="upload-area" id="dropArea">
                <i>üìÅ</i>
                <h3>Upload Your CSV File</h3>
                <p>Drag & Drop your file here or click to browse</p>
                <div class="upload-btn" id="uploadBtn">Choose File</div>
                <input type="file" id="csvFile" accept=".csv" hidden>
                <div class="file-name" id="fileName">No file selected</div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-preview" id="previewBtn">
                    <span>üëÅÔ∏è</span> Preview
                </button>
                <button class="btn btn-download" id="downloadPdfBtn" disabled>
                    <span>üì•</span> Download PDF
                </button>
            </div>
            
            <div id="loading">Generating PDF, please wait...</div>
            <div id="message"></div>
        </div>
        
        <div class="preview-section">
            <div class="preview-header">
                <h2 class="preview-title">Exam Paper Preview</h2>
            </div>
            <div class="preview-container" id="previewContainer">
                <div style="text-align: center; padding: 50px; color: #95a5a6;">
                    <p>Upload a CSV file and click "Preview" to see the exam paper here.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let examData = [];

        const csvFileInput = document.getElementById('csvFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const dropArea = document.getElementById('dropArea');
        const fileName = document.getElementById('fileName');
        const previewBtn = document.getElementById('previewBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const previewContainer = document.getElementById('previewContainer');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');

        uploadBtn.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', handleFileSelect);
        previewBtn.addEventListener('click', generatePreview);
        downloadPdfBtn.addEventListener('click', generatePDF);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.style.borderColor = '#f39c12';
            dropArea.style.backgroundColor = '#16213e';
        }

        function unhighlight() {
            dropArea.style.borderColor = '#e94560';
            dropArea.style.backgroundColor = '#1a1a2e';
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                csvFileInput.files = files;
                handleFileSelect();
            }
        }

        function handleFileSelect() {
            if (csvFileInput.files.length > 0) {
                const file = csvFileInput.files[0];
                fileName.textContent = file.name;
                message.innerHTML = '<div class="success-message">File selected successfully. Click "Preview" to generate exam paper.</div>';
                downloadPdfBtn.disabled = true;
            }
        }

        function generatePreview() {
            if (csvFileInput.files.length === 0) {
                message.innerHTML = '<div class="error-message">Please select a CSV file first.</div>';
                return;
            }
            
            const file = csvFileInput.files[0];
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    examData = results.data.filter(row => {
                        return row['Student Name'] && row['Student Name'].trim() !== '' && 
                               row['Roll No'] && row['Roll No'].trim() !== '';
                    });
                    
                    if (examData.length === 0) {
                        message.innerHTML = '<div class="error-message">No valid data found in the CSV file. Please check the format.</div>';
                        return;
                    }
                    
                    renderPreview();
                    downloadPdfBtn.disabled = false;
                    message.innerHTML = '<div class="success-message">Preview generated successfully. Click "Download PDF" to save.</div>';
                },
                error: function(error) {
                    console.error('Error parsing CSV:', error);
                    message.innerHTML = '<div class="error-message">Error parsing CSV file. Please check the file format.</div>';
                }
            });
        }

        function renderPreview() {
            previewContainer.innerHTML = '';
            
            const students = {};
            examData.forEach(row => {
                const studentKey = `${row['Student Name']}|${row['Roll No']}`;
                if (!students[studentKey]) {
                    students[studentKey] = {
                        name: row['Student Name'],
                        rollNo: row['Roll No'],
                        questions: {
                            MCQ: [],
                            'Short Q': [],
                            'Long Q': []
                        }
                    };
                }
                
                if (row['Question Text'] && row['Question Text'].trim() !== '') {
                    const question = {
                        number: row['Question Number'],
                        text: row['Question Text'],
                        type: row['Question Type'],
                        options: [
                            row['Option A'] || '',
                            row['Option B'] || '',
                            row['Option C'] || '',
                            row['Option D'] || ''
                        ].filter(opt => opt && opt.trim() !== '')
                    };
                    
                    let questionType = row['Question Type'];
                    if (students[studentKey].questions[questionType]) {
                        students[studentKey].questions[questionType].push(question);
                    }
                }
            });
            
            for (const studentKey in students) {
                const student = students[studentKey];
                
                student.questions.MCQ.sort((a, b) => parseInt(a.number) - parseInt(b.number));
                student.questions['Short Q'].sort((a, b) => parseInt(a.number) - parseInt(b.number));
                student.questions['Long Q'].sort((a, b) => parseInt(a.number) - parseInt(b.number));
                
                const pageContent = createPageContent(student);
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';
                pageDiv.innerHTML = pageContent;
                previewContainer.appendChild(pageDiv);
            }
        }

        function createPageContent(student) {
            let content = createPageHeader(student);
            
            content += `<div class="page-content-wrapper">`;

            if (student.questions.MCQ.length > 0) {
                content += `<div class="section-title">SECTION A: Multiple Choice Questions</div>`;
                student.questions.MCQ.forEach(q => {
                    content += `<div class="question"><div><strong>${q.number}.</strong> ${q.text}</div>`;
                    if (q.options.length > 0) {
                        content += `<div class="options">`;
                        q.options.forEach((opt, i) => {
                            content += `<div class="option"><strong>${String.fromCharCode(65 + i)}.</strong> ${opt}</div>`;
                        });
                        content += `</div>`;
                    }
                    content += `</div>`;
                });
            }

            if (student.questions['Short Q'].length > 0) {
                content += `<div class="section-title">SECTION B: Short Answer Questions</div>`;
                student.questions['Short Q'].forEach(q => {
                    content += `<div class="question"><div><strong>${q.number}.</strong> ${q.text}</div><div class="answer-space"></div></div>`;
                });
            }

            if (student.questions['Long Q'].length > 0) {
                content += `<div class="section-title">SECTION C: Long Answer Questions</div>`;
                student.questions['Long Q'].forEach(q => {
                    content += `<div class="question"><div><strong>${q.number}.</strong> ${q.text}</div><div class="long-answer-space"></div></div>`;
                });
            }

            content += `</div>`;
            return content;
        }

        function createPageHeader(student) {
            return `
                <div class="university-header">
                    <h2>My University - Department of Computer Science</h2>
                    <p><strong>Subject:</strong> Introduction to Computer Science</p>
                    <p><strong>Time:</strong> 3 Hours | <strong>Teacher:</strong> Dr. Alan Turing</p>
                </div>
                <div class="student-info">
                    <table>
                        <tr>
                            <td>Student Name:</td>
                            <td>${student.name}</td>
                        </tr>
                        <tr>
                            <td>Roll No:</td>
                            <td>${student.rollNo}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        async function generatePDF() {
            const loading = document.getElementById('loading');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const message = document.getElementById('message');
            const previewContainer = document.getElementById('previewContainer');
        
            if (previewContainer.innerHTML.includes('see the exam paper here')) {
                message.innerHTML = '<div class="error-message">Please generate a preview before downloading.</div>';
                return;
            }
        
            loading.style.display = 'block';
            downloadPdfBtn.disabled = true;
            message.innerHTML = '';
        
            try {
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
        
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
        
                const pagesToPrint = document.querySelectorAll('.page');
                
                let isFirstPageOfPDF = true;
        
                for (const pageElement of pagesToPrint) {
                    
                    const canvas = await html2canvas(pageElement, {
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });
        
                    const canvasImgData = canvas.toDataURL('image/png', 1.0);
                    const canvasAspectRatio = canvas.height / canvas.width;
                    const totalImageHeightInPDF = pdfWidth * canvasAspectRatio;
        
                    let heightLeft = totalImageHeightInPDF;
                    let currentPosition = 0;
        
                    while (heightLeft > 0) {
                        if (!isFirstPageOfPDF) {
                            pdf.addPage();
                        }
        
                        pdf.addImage(canvasImgData, 'PNG', 0, currentPosition, pdfWidth, totalImageHeightInPDF);
                        
                        heightLeft -= pdfHeight;
                        
                        currentPosition -= pdfHeight;
                        
                        isFirstPageOfPDF = false;
                    }
                }
                
                pdf.save('ExamPaper.pdf');
                message.innerHTML = '<div class="success-message">PDF downloaded successfully!</div>';
        
            } catch (error) {
                console.error('Error generating PDF:', error);
                message.innerHTML = `<div class="error-message">An error occurred while generating the PDF. See console for details.</div>`;
            } finally {
                loading.style.display = 'none';
                downloadPdfBtn.disabled = false;
            }
        }
    </script>
</body>
</html>

